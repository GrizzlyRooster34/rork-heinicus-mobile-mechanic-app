// This is your new schema.prisma file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Core Models ---

model User {
  id        String   @id @default(cuid())
  role      UserRole
  firstName String
  lastName  String
  email     String   @unique
  phone     String?
  address   String?
  joinedAt  DateTime @default(now())

  // Relations
  vehicles          Vehicle[]
  quotes            Quote[]
  jobsAsCustomer    Job[]             @relation("CustomerJobs")
  jobsAsMechanic    Job[]             @relation("MechanicJobs")
  notificationPrefs NotificationPref?
  pricingProfile    PricingProfile?
  availability      Availability?
}

model Vehicle {
  id      String  @id @default(cuid())
  userId  String
  user    User    @relation(fields: [userId], references: [id])
  vin     String? @unique
  year    Int?
  make    String?
  model   String?
  notes   String?

  // Relations
  quotes Quote[]
}

model Service {
  id                 String  @id @default(cuid())
  name               String
  category           String
  basePrice          Float
  defaultLaborRate   Float
  estHours           Float
  requiredTools      String[]

  // Relations
  quotes Quote[]
}

model Quote {
  id              String   @id @default(cuid())
  customerId      String
  customer        User     @relation(fields: [customerId], references: [id])
  vehicleId       String
  vehicle         Vehicle  @relation(fields: [vehicleId], references: [id])
  serviceId       String
  service         Service  @relation(fields: [serviceId], references: [id])
  lineItems       Json     // Store as JSON: [{ label: string, amount: number }]
  laborRate       Float
  estHours        Float
  travelFee       Float
  discountsApplied Json    // Store as JSON: [{ type: string, pct: number, amount: number }]
  status          QuoteStatus @default(PENDING)
  subtotal        Float
  taxes           Float?
  total           Float

  // Relations
  job Job?
}

model Job {
  id          String   @id @default(cuid())
  quoteId     String   @unique
  quote       Quote    @relation(fields: [quoteId], references: [id])
  customerId  String
  customer    User     @relation("CustomerJobs", fields: [customerId], references: [id])
  mechanicId  String?
  mechanic    User?    @relation("MechanicJobs", fields: [mechanicId], references: [id])
  status      JobStatus @default(PENDING)
  urgency     UrgencyLevel
  schedule    Json?    // Store as JSON: { start: datetime, end?: datetime }
  location    Json     // Store as JSON: { lat: number, lng: number, address?: string }
  photos      String[]
  partsUsed   Json     // Store as JSON: [{ name: string, qty: number, unit_cost: number }]
  timers      Json     // Store as JSON: [{ start: datetime, end?: datetime }]
  totals      Json     // Store as JSON: { labor: number, parts: number, fees: number, discounts: number, grand_total: number }
  rating      Json?    // Store as JSON: { stars: number, review?: string }
}

// --- Supporting Models ---

model PricingProfile {
  id            String @id @default(cuid())
  mechanicId    String @unique
  mechanic      User   @relation(fields: [mechanicId], references: [id])
  generalRates  Json   // Store as JSON: { standard: number, emergency: number, travel_fee: number, minimum: number }
  discounts     Json   // Store as JSON: { senior_pct: number, military_pct: number, repeat_pct: number }
}

model Availability {
  id                  String   @id @default(cuid())
  mechanicId          String   @unique
  mechanic            User     @relation(fields: [mechanicId], references: [id])
  daysEnabled         String[]
  startTime           String   // "HH:mm"
  endTime             String   // "HH:mm"
  maxJobsPerDay       Int
  travelRadiusMiles   Int
  autoAccept          Boolean
  emergencyEnabled    Boolean
}

model Tool {
  id        String   @id @default(cuid())
  name      String
  category  String
  required  Boolean
  available Boolean
  notes     String?
}

model NotificationPref {
  id          String  @id @default(cuid())
  userId      String  @unique
  user        User    @relation(fields: [userId], references: [id])
  jobUpdates  Boolean
  maintenance Boolean
  promos      Boolean
  emergency   Boolean
  quietHours  Json?   // Store as JSON: { start: "HH:mm", end: "HH:mm" }
}

model AnalyticsSnapshot {
  id          String @id @default(cuid())
  period      String // "week", "month", "quarter", "year"
  totals      Json
  breakdown   Json
  topServices Json?
}

// --- Enums ---

enum UserRole {
  CUSTOMER
  MECHANIC
  ADMIN
}

enum QuoteStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

enum JobStatus {
  PENDING
  ACTIVE
  COMPLETED
  CANCELED
}

enum UrgencyLevel {
  LOW
  MEDIUM
  HIGH
  EMERGENCY
}
