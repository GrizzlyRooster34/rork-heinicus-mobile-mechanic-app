// This is your new schema.prisma file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Core Models ---

model User {
  id        String   @id @default(cuid())
  role      UserRole
  firstName String
  lastName  String
  email     String   @unique
  phone     String?
  address   String?
  isActive  Boolean  @default(true)
  joinedAt  DateTime @default(now())

  // Relations
  vehicles              Vehicle[]
  quotes                Quote[]
  jobsAsCustomer        Job[]                 @relation("CustomerJobs")
  jobsAsMechanic        Job[]                 @relation("MechanicJobs")
  reviewsWritten        Review[]              @relation("ReviewsWritten")
  reviewsReceived       Review[]              @relation("ReviewsReceived")
  messagesSent          ChatMessage[]         @relation("SentMessages")
  messagesReceived      ChatMessage[]         @relation("ReceivedMessages")
  notificationPrefs     NotificationPref?
  pricingProfile        PricingProfile?
  availability          Availability?
  mechanicProfile       MechanicProfile?
  mechanicVerification  MechanicVerification?
  notifications         Notification[]
}

model Vehicle {
  id      String  @id @default(cuid())
  userId  String
  user    User    @relation(fields: [userId], references: [id])
  vin     String? @unique
  year    Int?
  make    String?
  model   String?
  notes   String?

  // Relations
  quotes Quote[]
}

model Service {
  id                 String  @id @default(cuid())
  name               String
  category           String
  basePrice          Float
  defaultLaborRate   Float
  estHours           Float
  requiredTools      String[]

  // Relations
  quotes Quote[]
}

model Quote {
  id              String   @id @default(cuid())
  customerId      String
  customer        User     @relation(fields: [customerId], references: [id])
  vehicleId       String
  vehicle         Vehicle  @relation(fields: [vehicleId], references: [id])
  serviceId       String
  service         Service  @relation(fields: [serviceId], references: [id])
  lineItems       Json     // Store as JSON: [{ label: string, amount: number }]
  laborRate       Float
  estHours        Float
  laborCost       Float?   // Labor cost calculation
  partsCost       Float?   // Parts cost calculation
  travelFee       Float
  discountsApplied Json    // Store as JSON: [{ type: string, pct: number, amount: number }]
  status          QuoteStatus @default(PENDING)
  subtotal        Float
  taxes           Float?
  total           Float
  totalCost       Float    // Total cost for the quote
  validUntil      DateTime? // Quote expiration date
  estimatedDuration Float? // Estimated duration in hours
  notes           String?  // Notes for the quote
  parts           Json?    // Store as JSON: [{ name: string, cost: number, qty: number }]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  job     Job?
  reviews Review[]
  payments Payment[]
}

model Job {
  id          String   @id @default(cuid())
  quoteId     String   @unique
  quote       Quote    @relation(fields: [quoteId], references: [id])
  customerId  String
  customer    User     @relation("CustomerJobs", fields: [customerId], references: [id])
  mechanicId  String?
  mechanic    User?    @relation("MechanicJobs", fields: [mechanicId], references: [id])
  status      JobStatus @default(PENDING)
  urgency     UrgencyLevel
  title       String?  // Job title/description
  category    String?  // Job category
  schedule    Json?    // Store as JSON: { start: datetime, end?: datetime }
  location    Json     // Store as JSON: { lat: number, lng: number, address?: string }
  photos      String[]
  partsUsed   Json     // Store as JSON: [{ name: string, qty: number, unit_cost: number }]
  timers      Json     // Store as JSON: [{ start: datetime, end?: datetime }]
  totals      Json     // Store as JSON: { labor: number, parts: number, fees: number, discounts: number, grand_total: number }
  rating      Json?    // Store as JSON: { stars: number, review?: string }
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  reviews      Review[]
  payments     Payment[]
  timelines    JobTimeline[]
}

model Review {
  id                   String   @id @default(cuid())
  jobId                String?
  job                  Job?     @relation(fields: [jobId], references: [id])
  quoteId              String?
  quote                Quote?   @relation(fields: [quoteId], references: [id])
  reviewerId           String
  reviewer             User     @relation("ReviewsWritten", fields: [reviewerId], references: [id])
  revieweeId           String
  reviewee             User     @relation("ReviewsReceived", fields: [revieweeId], references: [id])
  rating               Float    // Overall rating 1-5 stars
  punctualityRating    Float?   // 1-5 stars
  qualityRating        Float?   // 1-5 stars
  communicationRating  Float?   // 1-5 stars
  valueRating          Float?   // 1-5 stars
  comment              String?
  photos               String[] // Array of photo URIs
  response             String?  // Mechanic's response to review
  isVerified           Boolean  @default(false)
  reportCount          Int      @default(0)
  isHidden             Boolean  @default(false)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([jobId])
  @@index([quoteId])
  @@index([reviewerId])
  @@index([revieweeId])
}

model Payment {
  id                String   @id @default(cuid())
  userId            String?  // User who made the payment
  jobId             String?
  job               Job?     @relation(fields: [jobId], references: [id])
  quoteId           String?
  quote             Quote?   @relation(fields: [quoteId], references: [id])
  stripePaymentId   String   @unique // Stripe Payment Intent ID
  stripeIntentId    String?  // Alternative field name for Stripe Payment Intent ID
  amount            Float
  currency          String   @default("usd")
  status            String   // succeeded, pending, failed, etc.
  paymentMethod     String?  // card, apple_pay, google_pay
  refundAmount      Float?   // Amount refunded (if applicable)
  refundReason      String?  // Reason for refund
  metadata          Json?    // Additional payment metadata
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([jobId])
  @@index([quoteId])
  @@index([stripePaymentId])
  @@index([userId])
}

model JobTimeline {
  id          String   @id @default(cuid())
  jobId       String
  job         Job      @relation(fields: [jobId], references: [id])
  eventType   String   // CREATED, ACCEPTED, IN_PROGRESS, COMPLETED, CANCELED, etc.
  description String
  actorId     String?  // User who performed the action
  metadata    Json?    // Additional event metadata
  createdAt   DateTime @default(now())

  @@index([jobId])
  @@index([eventType])
}

model ChatMessage {
  id          String   @id @default(cuid())
  jobId       String?
  senderId    String
  sender      User     @relation("SentMessages", fields: [senderId], references: [id])
  receiverId  String
  receiver    User     @relation("ReceivedMessages", fields: [receiverId], references: [id])
  message     String
  messageType String?  @default("text") // text, image, file, etc.
  attachments Json?    // Array of attachment URLs/metadata
  isRead      Boolean  @default(false)
  metadata    Json?    // Additional message metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([jobId])
  @@index([senderId])
  @@index([receiverId])
}

// --- Supporting Models ---

model PricingProfile {
  id            String @id @default(cuid())
  mechanicId    String @unique
  mechanic      User   @relation(fields: [mechanicId], references: [id])
  generalRates  Json   // Store as JSON: { standard: number, emergency: number, travel_fee: number, minimum: number }
  discounts     Json   // Store as JSON: { senior_pct: number, military_pct: number, repeat_pct: number }
}

model Availability {
  id                  String   @id @default(cuid())
  mechanicId          String   @unique
  mechanic            User     @relation(fields: [mechanicId], references: [id])
  daysEnabled         String[]
  startTime           String   // "HH:mm"
  endTime             String   // "HH:mm"
  maxJobsPerDay       Int
  travelRadiusMiles   Int
  autoAccept          Boolean
  emergencyEnabled    Boolean
}

model Tool {
  id        String   @id @default(cuid())
  name      String
  category  String
  required  Boolean
  available Boolean
  notes     String?
}

model NotificationPref {
  id          String  @id @default(cuid())
  userId      String  @unique
  user        User    @relation(fields: [userId], references: [id])
  jobUpdates  Boolean
  maintenance Boolean
  promos      Boolean
  emergency   Boolean
  quietHours  Json?   // Store as JSON: { start: "HH:mm", end: "HH:mm" }
}

model AnalyticsSnapshot {
  id          String @id @default(cuid())
  period      String // "week", "month", "quarter", "year"
  totals      Json
  breakdown   Json
  topServices Json?
}

model MechanicProfile {
  id                String   @id @default(cuid())
  mechanicId        String   @unique
  mechanic          User     @relation(fields: [mechanicId], references: [id])
  bio               String?
  specialties       String[]
  yearsExperience   Int?
  certifications    String[]
  insuranceProvider String?
  insurancePolicyNo String?
  businessLicense   String?
  rating            Float?   @default(0.0)
  totalJobs         Int      @default(0)
  averageRating     Float?   @default(0.0)
  totalReviews      Int      @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model MechanicVerification {
  id                String   @id @default(cuid())
  mechanicId        String   @unique
  mechanic          User     @relation(fields: [mechanicId], references: [id])
  status            VerificationStatus @default(PENDING)
  fullName          String?
  photoUri          String?
  idUri             String?
  driversLicense    Boolean  @default(false)
  insurance         Boolean  @default(false)
  backgroundCheck   Boolean  @default(false)
  certifications    Boolean  @default(false)
  submittedAt       DateTime?
  verifiedAt        DateTime?
  verifiedBy        String?
  reviewedAt        DateTime?
  reviewedBy        String?
  notes             String?
  reviewNotes       String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model Notification {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  type        NotificationType
  title       String
  message     String
  data        Json?
  read        Boolean  @default(false)
  isDelivered Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@index([userId, read])
}

// --- Enums ---

enum UserRole {
  CUSTOMER
  MECHANIC
  ADMIN
}

enum QuoteStatus {
  PENDING
  APPROVED
  ACCEPTED
  REJECTED
  EXPIRED
}

enum JobStatus {
  PENDING
  QUOTED
  ACCEPTED
  ACTIVE
  COMPLETED
  CANCELED
}

enum UrgencyLevel {
  LOW
  MEDIUM
  HIGH
  EMERGENCY
}

enum VerificationStatus {
  PENDING
  IN_PROGRESS
  APPROVED
  REJECTED
}

enum NotificationType {
  JOB_ASSIGNED
  JOB_UPDATE
  QUOTE_RECEIVED
  PAYMENT_RECEIVED
  PAYMENT_UPDATE
  REVIEW_RECEIVED
  REVIEW_REQUEST
  CHAT_MESSAGE
  SYSTEM
  SYSTEM_ALERT
  EMERGENCY
}
