name: Build APK (Production Ready)

on:
  push:
    branches: [ main, integrated-production, production-ready-to-build ]
  pull_request:
    branches: [ main, integrated-production, production-ready-to-build ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build Type'
        required: true
        default: 'standalone'
        type: choice
        options:
          - standalone
          - preview
          - development
      version_bump:
        description: 'Version Bump Type'
        required: true
        default: 'build'
        type: choice
        options:
          - build
          - patch
          - minor
          - major

env:
  NODE_VERSION: '18'
  JAVA_VERSION: '17'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: ðŸ— Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸ— Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ðŸ— Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}

    - name: ðŸ“¦ Install dependencies
      run: |
        npm ci --legacy-peer-deps
        npm ls || true

    - name: ðŸ” Validate configuration
      run: |
        echo "ðŸ“± Validating app configuration..."
        if [ ! -f "app.json" ]; then
          echo "âŒ app.json not found"
          exit 1
        fi
        
        if [ ! -f "eas.json" ]; then
          echo "âŒ eas.json not found"
          exit 1
        fi
        
        echo "âœ… Configuration files found"
        
        # Validate package.json
        node -e "
          const pkg = require('./package.json');
          console.log('ðŸ“¦ Package:', pkg.name, 'v' + pkg.version);
          console.log('ðŸ· License:', pkg.license || 'None');
        "

    - name: ðŸ”¢ Bump version
      run: |
        BUILD_TYPE="${{ github.event.inputs.build_type || 'standalone' }}"
        VERSION_BUMP="${{ github.event.inputs.version_bump || 'build' }}"
        
        echo "ðŸ”¢ Bumping version (type: $VERSION_BUMP)"
        npm run bump:$VERSION_BUMP
        
        # Display build info
        if [ -f "build-info.json" ]; then
          echo "ðŸ“‹ Build Information:"
          cat build-info.json | jq '.'
        fi

    - name: ðŸ— Setup EAS CLI
      run: |
        npm install -g eas-cli@latest
        eas --version

    - name: ðŸ” Authenticate with EAS
      run: |
        if [ -z "${{ secrets.EXPO_TOKEN }}" ]; then
          echo "âŒ EXPO_TOKEN not found in secrets"
          echo ""
          echo "ðŸ”§ Setup Instructions:"
          echo "1. Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
          echo "2. Add new secret: EXPO_TOKEN"
          echo "3. Get token: https://expo.dev/accounts/[account]/settings/access-tokens"
          echo ""
          exit 1
        fi
        echo "âœ… EAS authentication configured"
      env:
        EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

    - name: ðŸ— Setup Android SDK
      run: |
        echo "ðŸ— Setting up Android SDK..."
        echo "ANDROID_HOME=/opt/android-sdk" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=/opt/android-sdk" >> $GITHUB_ENV
        echo "/opt/android-sdk/platform-tools" >> $GITHUB_PATH
        echo "/opt/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH
    
    - name: ðŸ“¦ Export JS bundle
      run: |
        echo "ðŸ“¦ Exporting JavaScript bundle..."
        mkdir -p android/app/src/main/assets
        npx expo export --dev --output-dir export
        cp export/android-index.bundle android/app/src/main/assets/index.android.bundle
        cp -r export/assets android/app/src/main/res/
        echo "âœ… JS bundle exported successfully"
    
    - name: ðŸ— Generate native Android project
      run: |
        echo "ðŸ— Generating native Android project..."
        npx expo prebuild --platform android --clean
        echo "âœ… Native project generated"
    
    - name: ðŸš€ Build APK with Gradle
      run: |
        echo "ðŸš€ Building APK with Gradle..."
        cd android
        ./gradlew clean
        ./gradlew assembleRelease
        echo "âœ… APK build completed"
        
        # Find the generated APK
        APK_PATH=$(find . -name "*.apk" -type f | head -1)
        if [ -n "$APK_PATH" ]; then
          echo "ðŸ“± APK found: $APK_PATH"
          # Copy to root for easier access
          cp "$APK_PATH" ../app-release.apk
          echo "âœ… APK copied to root directory"
        else
          echo "âŒ No APK found"
          exit 1
        fi

    - name: ðŸ“Š Build Summary
      run: |
        echo "## ðŸš€ APK Build Completed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Build information
        if [ -f "build-info.json" ]; then
          VERSION=$(cat build-info.json | jq -r '.version')
          VERSION_CODE=$(cat build-info.json | jq -r '.versionCode')
          PACKAGE=$(cat build-info.json | jq -r '.package')
          BUILD_DATE=$(cat build-info.json | jq -r '.buildDate')
          
          echo "### ðŸ“± Build Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Number:** $VERSION_CODE" >> $GITHUB_STEP_SUMMARY
          echo "- **Package:** $PACKAGE" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Date:** $BUILD_DATE" >> $GITHUB_STEP_SUMMARY
          echo "- **Profile:** ${{ github.event.inputs.build_type || 'standalone' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Installation instructions
        echo "### ðŸ“² Installation" >> $GITHUB_STEP_SUMMARY
        echo "1. Download APK from EAS build dashboard" >> $GITHUB_STEP_SUMMARY
        echo "2. Transfer to OnePlus 9 Pro" >> $GITHUB_STEP_SUMMARY
        echo "3. Install: \`adb install app.apk\`" >> $GITHUB_STEP_SUMMARY
        echo "4. Or enable 'Unknown Sources' and install directly" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Build result
        if [ -f "build-result.json" ]; then
          BUILD_ID=$(cat build-result.json | jq -r '.[0].id // "N/A"')
          echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "- **EAS Build ID:** $BUILD_ID" >> $GITHUB_STEP_SUMMARY
          echo "- **EAS Dashboard:** https://expo.dev/accounts/heinicus1/projects/heinicus-mobile-mechanic-app/builds" >> $GITHUB_STEP_SUMMARY
        fi

    - name: ðŸ“¤ Upload build artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: build-artifacts
        path: |
          build-info.json
          build-result.json
          eas-build-*.log
        retention-days: 30

    - name: ðŸ’¬ Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          let buildInfo = {};
          try {
            buildInfo = JSON.parse(fs.readFileSync('build-info.json', 'utf8'));
          } catch (e) {
            console.log('No build info available');
          }
          
          const comment = `## ðŸš€ APK Build Status
          
          âœ… **Build Successful**
          
          **Build Details:**
          - Version: ${buildInfo.version || 'Unknown'}
          - Build Number: ${buildInfo.versionCode || 'Unknown'}
          - Package: ${buildInfo.package || 'Unknown'}
          - Profile: ${{ github.event.inputs.build_type || 'standalone' }}
          
          **Next Steps:**
          1. Check the [EAS Dashboard](https://expo.dev/accounts/heinicus1/projects/heinicus-mobile-mechanic-app/builds) for download
          2. Test on OnePlus 9 Pro
          3. Verify all functionality works as expected
          
          Build triggered by: ${context.actor}`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });