name: Build with EAS Cloud (Production)

on:
  push:
    branches: [ main, integrated-production, production-ready-to-build ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm install --legacy-peer-deps
        
    - name: Setup EAS CLI
      run: npm install -g eas-cli@latest
        
    - name: Build APK with EAS Cloud (JS Bundle Included)
      env:
        EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      run: |
        echo "ðŸš€ Starting EAS build with embedded JS bundle..."
        
        if [ -z "$EXPO_TOKEN" ]; then
          echo "âŒ EXPO_TOKEN not found in secrets"
          echo "Please add your EAS access token to GitHub repository secrets"
          echo "1. Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
          echo "2. Add new secret: EXPO_TOKEN = your_eas_access_token"
          echo "3. Get token by running: eas login && eas build:configure"
          exit 1
        fi
        
        echo "âœ… Authentication token found"
        echo "ðŸ“± Submitting build to EAS cloud with JS bundle..."
        
        # Configure EAS if needed
        npx eas build:configure --platform android --non-interactive || true
        
        # Submit build to EAS cloud (automatically includes JS bundle)
        npx eas build --platform android --profile standalone --non-interactive --wait --json > build-result.json
        
        echo "âœ… Build completed"
        if [ -f "build-result.json" ]; then
          echo "ðŸ“‹ Build details:"
          cat build-result.json | jq '.'
        fi
        
    - name: Build Summary
      run: |
        echo "## ðŸš€ EAS Cloud Build Submitted" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The build has been submitted to Expo's cloud build service." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“± Next Steps:" >> $GITHUB_STEP_SUMMARY
        echo "1. Check the EAS build dashboard for progress" >> $GITHUB_STEP_SUMMARY
        echo "2. Download the APK when the build completes" >> $GITHUB_STEP_SUMMARY
        echo "3. Install on OnePlus 9 Pro: \`adb install app.apk\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Build Configuration:**" >> $GITHUB_STEP_SUMMARY
        echo "- Platform: Android" >> $GITHUB_STEP_SUMMARY
        echo "- Profile: standalone" >> $GITHUB_STEP_SUMMARY
        echo "- Output: APK" >> $GITHUB_STEP_SUMMARY
        echo "- Package: app.rork.mobilemechanic" >> $GITHUB_STEP_SUMMARY